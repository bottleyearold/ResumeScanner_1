<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Resume Analyzer</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Resume.AI</a>
    <div class="collapse navbar-collapse">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="/admin.html">Admin Input</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/jobs.html">Job Listings</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/resume.html">Resume Analyzer</a>
            </li>
        </ul>
    </div>
</nav>

<!-- Resume Upload and Analyzer Form -->
<form id="resumeForm" enctype="multipart/form-data">
    <div class="container mt-4">
        <h3>Upload Resume (PDF):</h3>
        <div class="form-group">
            <label for="file-input">Select Resume PDF:</label>
            <input id="file-input" class="form-control" type="file" accept=".pdf" required>
        </div>

        <div class="form-group">
            <button type="button" class="btn btn-primary" onclick="analyzeResume()">Analyze</button>
        </div>
    </div>
</form>

<!-- Results section will display job and analysis results side-by-side -->
<div class="container mt-4" id="analysis-section">
</div>

<script type="text/javascript">
    function analyzeResume() {
        var fileInput = document.getElementById("file-input");

        // Validate file input
        if (!fileInput.files.length) {
            alert("Please select a resume PDF file.");
            return;
        }

        // Fetch job listings to compare against resume
        $.ajax({
            type: 'GET',
            url: "http://localhost:8080/api/v1/jobs",
            success: function(jobs) {
                console.log('Jobs API response:', jobs);  // Debugging log
                analyzeWithJobs(fileInput.files[0], jobs);  // Call function to analyze resume
            },
            error: function(error) {
                console.log(error);
                alert('Error fetching jobs');
            }
        });
    }

    function analyzeWithJobs(resumeFile, jobs) {
        var formData = new FormData();
        formData.append("resume", resumeFile);

        // Check if jobs data is available
        if (!jobs || jobs.length === 0) {
            $("#analysis-section").html("<span style='color: red;'>No job listings found.</span>");
            return;
        }

        // Convert job criteria into JSON format
        var criteriaJson = JSON.stringify(jobs.map(job => ({
            jobName: job.jobName,  // Added jobName
            codingLanguages: job.codingLanguages,
            gpa: job.gpa,
            priorExperience: job.priorExperience,
            preferredLocations: job.preferredLocations,
            majors: job.majors,
            language: job.languages
        })));

        formData.append("criteria", criteriaJson);

        // Send resume file and criteria to the back-end for analysis
        $.ajax({
            type: 'POST',
            url: "http://localhost:8080/api/v1/analyze",
            processData: false,
            contentType: false,
            data: formData,
            success: function(response) {
                var resultHtml = '';

                // Create side-by-side structure for each job
                response.forEach(function(match, index) {
                    // Check if the job exists at the current index
                    if (jobs[index]) {
                        resultHtml += '<div class="row">';
                        resultHtml += '   <div class="col-md-6">';
                        resultHtml += '       <h5>' + jobs[index].jobName + ' (' + (index + 1) + '):</h5>';  // Display Job Name
                        resultHtml += '       <p><strong>Coding Languages:</strong> ' + (jobs[index].codingLanguages ? jobs[index].codingLanguages.join(", ") : 'N/A') + '</p>';
                        resultHtml += '       <p><strong>GPA:</strong> ' + (jobs[index].gpa ? jobs[index].gpa : 'N/A') + '</p>';
                        resultHtml += '       <p><strong>Experience:</strong> ' + (jobs[index].priorExperience ? jobs[index].priorExperience + ' years' : 'N/A') + '</p>';
                        resultHtml += '       <p><strong>Preferred Locations:</strong> ' + (jobs[index].preferredLocations ? jobs[index].preferredLocations.join(", ") : 'N/A') + '</p>';
                        resultHtml += '       <p><strong>Majors:</strong> ' + (jobs[index].majors ? jobs[index].majors.join(", ") : 'N/A') + '</p>';
                        resultHtml += '       <p><strong>Languages:</strong> ' + (jobs[index].languages ? jobs[index].languages.join(", ") : 'N/A') + '</p>';
                        resultHtml += '   </div>';

                        // Display analysis results next to the job description
                        resultHtml += '   <div class="col-md-6">';
                        resultHtml += '       <h5>Matching Results:</h5>';
                        if (Array.isArray(match)) {
                            match.forEach(function(result) {
                                var color = result.matched ? 'green' : 'red';
                                resultHtml += '<p style="color: ' + color + '">' + result.field + ': ' + result.value + '</p>';
                            });
                        } else {
                            resultHtml += '<p>No matching results available.</p>';
                        }
                        resultHtml += '   </div>';
                        resultHtml += '</div><hr>';
                    }
                });

                // Set resultHtml inside the analysis section
                $("#analysis-section").html(resultHtml);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                $("#analysis-section").html("<span style='color: red;'>An error occurred: " + errorThrown + "</span>");
            }
        });
    }
</script>

</body>
</html>
