<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Resume Analyzer</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Resume.AI</a>
    <div class="collapse navbar-collapse">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="/admin.html">Admin Input</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/jobs.html">Job Listings</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/resume.html">Resume Analyzer</a>
            </li>
        </ul>
    </div>
</nav>

<!-- Resume Upload and Analyzer Form -->
<form id="resumeForm" enctype="multipart/form-data">
    <div class="container mt-4">
        <h3>Upload Resume (PDF):</h3>
        <div class="form-group">
            <label for="file-input">Select Resume PDF:</label>
            <input id="file-input" class="form-control" type="file" accept=".pdf" required>
        </div>

        <div class="form-group">
            <button type="button" class="btn btn-primary" onclick="analyzeResume()">Analyze</button>
        </div>
    </div>
</form>

<!-- Results section will display job and analysis results side-by-side -->
<div class="container mt-4" id="analysis-section">
</div>

<script type="text/javascript">
    function analyzeResume() {
        var fileInput = document.getElementById("file-input");

        // Validate file input
        if (!fileInput.files.length) {
            alert("Please select a resume PDF file.");
            return;
        }

        // Fetch job listings to compare against resume
        $.ajax({
            type: 'GET',
            url: "http://localhost:8080/api/v1/jobs",
            success: function(jobs) {
                console.log('Jobs API response:', jobs);  // Debugging log
                analyzeWithJobs(fileInput.files[0], jobs);  // Call function to analyze resume
            },
            error: function(error) {
                console.log(error);
                alert('Error fetching jobs');
            }
        });
    }

    function analyzeWithJobs(resumeFile, jobs) {
        var formData = new FormData();
        formData.append("resume", resumeFile);

        // Check if jobs data is available
        if (!jobs || jobs.length === 0) {
            $("#analysis-section").html("<span style='color: red;'>No job listings found.</span>");
            return;
        }

        // Convert job criteria into JSON format
        var criteriaJson = JSON.stringify(jobs.map(job => ({
            jobName: job.jobName,
            codingLanguages: job.codingLanguages,
            gpa: job.gpa,
            priorExperience: job.priorExperience,
            preferredLocations: job.preferredLocations,
            majors: job.majors,
            language: job.languages
        })));

        formData.append("criteria", criteriaJson);

        // Send resume file and criteria to the back-end for analysis
        $.ajax({
            type: 'POST',
            url: "http://localhost:8080/api/v1/analyze",
            processData: false,
            contentType: false,
            data: formData,
            success: function(response) {
                console.log('Jobs:', JSON.stringify(jobs, null, 2));
                console.log('Response from server:', JSON.stringify(response, null, 2));

                let resultHtml = '';

                jobs.forEach(function(job) {
                    console.log('Job:', job);  // Debug: Log job details for debugging

                    // Filter matching results for the current job based on fields like "Coding Skill", "Location", etc.
                    let jobResults = response.filter(result => {
                        console.log('Result:', result);  // Debug: Log each result being filtered
                        if (result.field === 'Coding Skill' && job.codingLanguages.includes(result.value)) {
                            return true;
                        }
                        if (result.field === 'State' && job.preferredLocations.includes(result.value)) {
                            return true;
                        }
                        if (result.field === 'Major' && job.majors.includes(result.value)) {
                            return true;
                        }
                        if (result.field === 'Language' && job.languages.includes(result.value)) {
                            return true;
                        }
                        return false;
                    });

                    // Debugging: Log the jobResults after filtering
                    console.log('Job Results:', jobResults);

                    let uniqueResults = new Set();

                    // Start building HTML for this job's results
                    resultHtml += '<div class="row">';
                    resultHtml += '   <div class="col-md-6">';
                    resultHtml += `       <h5>${job.jobName || 'Unknown Job'}:</h5>`;
                    resultHtml += `       <p><strong>Coding Languages:</strong> ${job.codingLanguages?.join(", ") || 'N/A'}</p>`;
                    resultHtml += `       <p><strong>GPA:</strong> ${job.gpa || 'N/A'}</p>`;
                    resultHtml += `       <p><strong>Experience:</strong> ${job.priorExperience || 'N/A'} years</p>`;
                    resultHtml += `       <p><strong>Preferred Locations:</strong> ${job.preferredLocations?.join(", ") || 'N/A'}</p>`;
                    resultHtml += `       <p><strong>Majors:</strong> ${job.majors?.join(", ") || 'N/A'}</p>`;
                    resultHtml += `       <p><strong>Languages:</strong> ${job.languages?.join(", ") || 'N/A'}</p>`;
                    resultHtml += '   </div>';

                    resultHtml += '   <div class="col-md-6">';
                    resultHtml += '       <h5>Matching Results:</h5>';

                    if (Array.isArray(jobResults) && jobResults.length > 0) {
                        jobResults.forEach(function(result) {
                            let uniqueKey = `${result.field}: ${result.value}`;

                            // Check if this key has already been added; if not, add it
                            if (!uniqueResults.has(uniqueKey)) {
                                var color = result.matched ? 'green' : 'red';
                                resultHtml += `<p style="color: ${color}">${result.field}: ${result.value}</p>`;
                                uniqueResults.add(uniqueKey);
                            }
                        });
                    } else {
                        resultHtml += '<p>No matching results available.</p>';
                    }

                    resultHtml += '   </div>';
                    resultHtml += '</div><hr>';
                });

                // Insert the generated HTML into the analysis section
                $("#analysis-section").html(resultHtml);
            },

            error: function(jqXHR, textStatus, errorThrown) {
                $("#analysis-section").html(`<span style='color: red;'>An error occurred: ${errorThrown}</span>`);
            }
        });
    }











</script>

</body>
</html>

